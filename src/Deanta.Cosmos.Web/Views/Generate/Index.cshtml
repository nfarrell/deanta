@model int
<h2>How many todos do you want to have?</h2>
<h4>There are currenty <strong>@Model.ToString("##,###") todos</strong> in the SQL database.</h4>

<h3 class="text-danger">WARNING!</h3>
<p class="text-danger">
    This can take a LONG time! On my (fast) PC it takes 2 minutes to generate 10,000 todos with associated NoSQL entries.
    Use the web.config file with a requestTimeout of 20 minutes, so that it doesn't time out the action
</p>

<div class="form-horizontal">
    <form asp-controller="Generate" asp-action="Todos" method="post" id="input-form">
        <!-- Input and Submit elements -->

        <div class="form-group">
            <div class="col-sm-2">
                <label class="control-label">Total todos you want</label>
            </div>
            <div class="col-sm-10">
                <input name="totalTodosNeeded" id="totalTodosNeeded" value="10000" class="form-control col-sm-10" />
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-2">
                <label class="control-label">Wipe database?</label>
            </div>
            <div class="col-sm-1">
                <input type="checkbox" name="wipeDatabase" value="true" class="form-control" />
                <input type="hidden" name="wipeDatabase" value="false" />
            </div>
        </div>

        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <button type="submit" onclick="startGenerate()">Generate</button>
            </div>
        </div>

    </form>

</div>

<p>
    <strong>NOTE:</strong> to stop the generator refresh this page, or go to a different page. It stops at the next batch update. References <a href="https://andrewlock.net/using-cancellationtokens-in-asp-net-core-mvc-controllers/">Using CancellationTokens in ASP.NET Core MVC controllers</a>
    for how to do that.
</p>
<hr />
<H4 id="show-num-todos" class="hidden">
</H4>

<script>
    function startGenerate() {
        var form = $('#input-form');
        startUpdatingProgressIndicator();
        $.post(
            form.attr('action'),
            form.serialize
        );
    }

    var intervalId;

    function startUpdatingProgressIndicator() {
        var $progress = $("#show-num-todos");
        $progress.removeClass('hidden');

        var skipFirst = true;
        intervalId = setInterval(
            function () {
                // We use the POST requests here to avoid caching problems (we could use the GET requests and disable the cache instead)
                $.post(
                    '@Url.Action("NumTodos")',
                    {},
                    function (data, status) {
                        if (skipFirst) {
                            skipFirst = false;
                            return;
                        }
                        $progress.html(data);
                    }
                );
            },
            1000
        );
    }

    function stopUpdatingProgressIndicator() {
        clearInterval(intervalId);
    }
</script>